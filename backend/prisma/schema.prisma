// Ethical Shopping Platform Database Schema - PostgreSQL (Supabase)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Products table - stores scraped product information
model Product {
  id            String   @id @default(cuid())
  url           String   @unique
  title         String
  description   String?
  price         Float
  originalPrice Float?
  currency      String   @default("INR")
  platform      String // amazon, flipkart, etc.
  productId     String // platform-specific product ID
  brand         String?
  category      String?
  rating        Float?
  reviewCount   Int?
  availability  String   @default("unknown")
  imageUrl      String?
  features      String? // JSON array as string
  scrapedAt     DateTime @default(now())

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  analyses     Analysis[]
  priceHistory PriceHistory[]

  @@index([platform])
  @@index([brand])
  @@index([createdAt])
}

// Analysis results table - stores each product analysis
model Analysis {
  id        String @id @default(cuid())
  productId String

  // Scores
  dealScore    Float
  ethicalScore Float
  trustScore   Float

  // Analysis results
  decision       String // buy_now, wait, avoid, insufficient_data
  recommendation String
  confidence     Float

  // Price analysis
  isGoodDeal       Boolean
  savingsAmount    Float?
  priceRank        String // lowest, below_average, average, above_average, highest
  marketComparison String

  // AI insights
  honestAssessment String
  pros             String? // JSON array as string
  cons             String? // JSON array as string
  warnings         String? // JSON array as string

  // Sustainability
  brandRating         Float
  environmentalImpact String
  ethicalSourcing     Float

  // Metadata
  analysisVersion String  @default("1.0")
  aiModel         String? // gemini-pro, gpt-4, etc.
  processingTime  Int? // milliseconds

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  alternatives    Alternative[]
  ruleEvaluations RuleEvaluation[]
  userSavings     UserSavings[]

  @@index([productId])
  @@index([createdAt])
}

// Alternative products suggested for each analysis
model Alternative {
  id         String @id @default(cuid())
  analysisId String

  title        String
  url          String
  price        Float?
  ethicalScore Float
  rationale    String
  confidence   Float
  platform     String

  // Relations
  analysis Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
}

// Price history tracking
model PriceHistory {
  id        String @id @default(cuid())
  productId String

  price    Float
  currency String

  // Timestamp when price was recorded
  recordedAt DateTime @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([recordedAt])
}

// Rules evaluation results
model RuleEvaluation {
  id         String @id @default(cuid())
  analysisId String

  ruleId   String
  ruleName String

  contribution Float // How much this rule contributed to ethical score
  reason       String
  passed       Boolean

  // Relations
  analysis Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
  @@index([ruleId])
}

// Track actual savings when users follow recommendations
model UserSavings {
  id         String @id @default(cuid())
  analysisId String?

  amount        Float   // Actual savings amount (INR)
  originalPrice Float   // Price user would have paid
  finalPrice    Float   // Price actually paid
  currency      String  @default("INR")
  
  productTitle  String
  platform      String?
  
  // When user made the purchase
  purchasedAt   DateTime @default(now())
  recordedAt    DateTime @default(now())
  
  // Optional user tracking
  userId        String?
  sessionId     String?
  
  // Relations
  analysis      Analysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)

  @@index([purchasedAt])
  @@index([recordedAt])
  @@index([analysisId])
}
