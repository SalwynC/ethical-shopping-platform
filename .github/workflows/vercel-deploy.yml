name: Deploy frontend to Vercel

on:
  push:
    branches: [ main ]
    # avoid deploys for doc-only changes
    paths-ignore:
      - 'documentation/**'
      - '**/*.md'
      - '.github/dependabot.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies (root)
        run: npm ci --workspaces --prefer-offline
      - name: Build frontend
        run: |
          cd frontend
          npm ci --prefer-offline
          npm run build
      - name: Deploy to Vercel
        id: vercel_deploy
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' }}
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          working-directory: "frontend"
          github-token: ${{ secrets.GITHUB_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Get deployment preview URL and smoke test
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' }}
        run: |
          echo "Deployment preview url: ${{ steps.vercel_deploy.outputs.preview-url }}"
          # Wait a few seconds for the deployment to be routable
          sleep 5
          curl -fS --max-time 10 "${{ steps.vercel_deploy.outputs.preview-url }}" || (echo "Smoke test failed for deployment URL" && exit 1)

      - name: Comment on PR with preview URL
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' && github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… Vercel deployment completed.

            - Preview URL: ${{ steps.vercel_deploy.outputs.preview-url }}
            - GitHub Actions run: ${{ github.run_id }}

            If you don't see the site responding, check the project settings on Vercel (build command, environment variables). If Vercel is still set up via the GitHub App integration, consider disabling it (set `github.enabled: false` in `vercel.json`) to prevent duplicate/cancelled deployments.

      - name: Skip deploy - Vercel secrets missing
        if: ${{ secrets.VERCEL_TOKEN == '' || secrets.VERCEL_ORG_ID == '' || secrets.VERCEL_PROJECT_ID == '' }}
        run: |
          echo "Vercel secrets not configured; skipping deploy."
          echo "Add VERCEL_TOKEN, VERCEL_ORG_ID and VERCEL_PROJECT_ID to repository secrets to enable auto-deploy."
